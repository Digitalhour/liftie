#!/usr/bin/env node

var program = require('commander');
var url = require('url');
var fs = require('fs');
var path = require('path');
var request = require('superagent');
var _ = require('lodash');

program
  .option('-r, --resort <resort>', 'Short name of the resort', String)
  .option('-n, --name <name>', 'Human readable name of the resort', String)
  .option('-u, --url <url>', 'URL of the resort lift status page', String)
  .parse(process.argv);

function params(resort, name, statusUrl) {
  if(!resort) {
    program.prompt('Short name of the resort [acme]: ', function(resort) {
      params(resort || 'acme', name, statusUrl);
    });
    return;
  }
  if (!name) {
    program.prompt('Human readable name of the resort [Acme Ski]: ', function(name) {
      params(resort, name || 'Acme Ski', statusUrl);
    });
    return;
  }
  if (!statusUrl) {
    program.prompt('URL of the page with lift status [http://acme.com/lift/status]: ', function(statusUrl) {
      params(resort, name, statusUrl || 'http://acme.com/lift/status');
    });
    return;
  }

  var resortUrl = url.parse(statusUrl);
  process.stdin.destroy();
  generate({
    id: resort,
    name: name,
    host: [resortUrl.protocol, '//', resortUrl.host].join(''),
    pathname: [resortUrl.pathname, resortUrl.search, resortUrl.hash].join('')
  });
}


function generate(resort) {
  console.log('Generating files for %s', resort.name);
  var templates = path.resolve(__dirname, '../templates'),
    lib = path.resolve(__dirname, '../lib/resorts'),
    test = path.resolve(__dirname, '../test/resorts'),
    resortDir = path.join(lib, resort.id);

  fs.mkdirSync(resortDir);
  copy(path.join(templates, 'index.js'), path.join(resortDir, 'index.js'), resort);
  write(path.join(resortDir, 'resort.json'), {
    name: resort.name,
    url: {
      host: resort.host,
      pathname: resort.pathname
    },
    tags: []
  });
  copy(path.join(templates, 'test.js'), path.join(test, resort.id + '.js'), resort);
  curl(resort.host + resort.pathname, path.join(test, 'example', resort.id + '.html'));
}


function write(dst, json) {
  console.log('Generating %s...', dst);
  fs.writeFile(dst, JSON.stringify(json, null, 1));
}

function copy(src, dst, params) {
  console.log('Generating %s...', dst);
  fs.readFile(src, 'utf8', function(err, data) {
    data = _.template(data, params);
    fs.writeFile(dst, data);
  });
}

function curl(url, dst) {
  var dstStream = fs.createWriteStream(dst);
  console.log('Retrieving %s to %s...', url, dst);
  request.get(url).pipe(dstStream);
}

params(program.resort, program.name, program.url);
